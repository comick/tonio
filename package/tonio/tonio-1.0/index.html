<!DOCTYPE html>
<html>
    <head>
        <title>Tonio</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>

            html { 
                height: 100%;
                margin: 0;
                padding: 0;
            }

            body {
                background-color: #44475a;
                color: #f8f8f2;
                font-family: sans-serif;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            ul.menu {
                list-style-type: none;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }

            ul.menu li {
                float: left;
            }


            a {
                color: #8be9fd;
            }
            a:visited {
                color: #bd93f9;
            }

            li a, li a:visited {
                display: block;
                color: #f8f8f2;
                text-align: center;
                padding: 1em 1em;
                font-weight: bold;
                text-decoration: none;
            }

            li a:hover:not(.active) {
                background-color: #6272a4;
            }

            .active {
                background-color: #282a36;
            }

            .stage {
                padding: 1em;
                background-color: #282a36;
                display: none;
                overflow: auto;
            }

            .log {
                white-space: pre;
                font-family: monospace;
            }

        </style>
        <script type="text/javascript">
            /**
             * Copyright (c) 2020 Michele Comignano <comick@gmail.com>
             * This file is part of Tonio.
             *
             * Tonio is free software: you can redistribute it and/or modify
             * it under the terms of the GNU General Public License as published by
             * the Free Software Foundation, either version 3 of the License, or
             * (at your option) any later version.
             *
             * Tonio is distributed in the hope that it will be useful,
             * but WITHOUT ANY WARRANTY; without even the implied warranty of
             * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
             * GNU General Public License for more details.
             *
             * You should have received a copy of the GNU General Public License
             * along with Tonio.  If not, see <http://www.gnu.org/licenses/>.
             */
            window.onload = function () {
                window.stage = (function () {

                    var currentStageId;

                    var stages = {

                        status: (function () {

                            var currentTagElem = document.getElementById('current-tag');
                            var currentTrackElem = document.getElementById('current-track');
                            var totalTracksElem = document.getElementById('total-tracks');
                            var currentTrackResElem = document.getElementById('current-track-res');

                            function displayStatus() {
                                fetch('/status').then(resp => {
                                    return resp.json();
                                }).then(statusResponse => {
                                    currentTagElem.innerHTML = (statusResponse.present && statusResponse.id) || 'none';
                                    currentTrackElem.innerHTML = (typeof statusResponse.track_current === 'number') ? statusResponse.track_current : '-';
                                    totalTracksElem.innerHTML = (statusResponse.track_total && statusResponse.track_total) || '-';
                                    currentTrackResElem.innerHTML = (statusResponse.track_name && statusResponse.track_name) || '-';
                                });

                            }

                            var refreshCurrentTag;

                            return {
                                open: function (rootElem) {
                                    currentTagElem.innerHTML = 'none';
                                    displayStatus();
                                    refreshCurrentTag = setInterval(displayStatus, 2000);
                                },
                                close: function (rootElem) {
                                    clearInterval(refreshCurrentTag);
                                }
                            }
                        }()),

                        library: (function () {

                            return {
                                open: function (rootElem) {
                                    rootElem.innerHTML = 'Loading...';
                                    fetch('/library').then(resp => {
                                        return resp.json();
                                    }).then(libraryTags => {
                                        rootElem.innerHTML = '';
                                        var libraryItemsElem = document.createElement('ul');
                                        rootElem.appendChild(libraryItemsElem);

                                        libraryTags.forEach(function (tagId) {

                                            // Tag id starts list
                                            var libraryItemElem = document.createElement('li');
                                            libraryItemElem.innerHTML = tagId;
                                            libraryItemsElem.appendChild(libraryItemElem);

                                            var tracksListELem = document.createElement('ol');
                                            libraryItemsElem.appendChild(tracksListELem);

                                            fetch('/library/' + tagId).then(resp => {
                                                return resp.text();
                                            }).then(playlist => {
                                                var tracks = playlist.match(/[^\n]+/g);
                                                tracks.forEach(function (track) {
                                                    var trackElem = document.createElement('li');
                                                    trackElem.innerHTML = track;
                                                    tracksListELem.appendChild(trackElem);

                                                });
                                            });

                                        });
                                    });

                                },
                                close: function (rootElem) { }
                            }
                        }()),

                        log: (function () {

                            function displayLog(rootElem) {
                                fetch('/log').then(resp => {
                                    return resp.text();
                                }).then(log => {
                                    rootElem.innerHTML = log.match(/[^\n]+/g).reverse().join('\n');
                                });
                            }

                            var refreshLog;

                            return {
                                open: function (rootElem) {
                                    rootElem.innerHTML = "Loading...";
                                    displayLog(rootElem);
                                    refreshLog = setInterval(displayLog.bind(null, rootElem), 2000);
                                },
                                close: function (rootElem) {
                                    clearInterval(refreshLog);
                                }
                            }
                        }()),

                        about: (function () {

                            return {
                                open: function (rootElem) { },
                                close: function (rootElem) { }
                            }
                        }()),

                    };

                    return function (stageId) {

                        if (!stages.hasOwnProperty(stageId))
                            return false;

                        if (currentStageId) {
                            var previousRootElem = document.getElementById(currentStageId + '-stage');
                            previousRootElem.style = 'display: none';
                            stages[currentStageId].close(previousRootElem);
                            document.getElementById(currentStageId + '-href').classList.toggle('active');
                        }

                        currentStageId = stageId;
                        var currentRootElem = document.getElementById(currentStageId + '-stage')
                        stages[currentStageId].open(currentRootElem);
                        currentRootElem.style = 'display: block';
                        window.location.hash = '#' + currentStageId;
                        document.getElementById(currentStageId + '-href').classList.toggle('active');
                        return true;
                    };

                }());

                var hash = window.location.hash.substr(1);
                (hash && stage(hash)) || stage('status');
            };
        </script>
    </head>
    <body>

        <ul class="menu">
            <li onclick="stage('status');"><a id="status-href" href="#status">Status</a></li>
            <li onclick="stage('library');"><a id="library-href" href="#library">Library</a></li>
            <li onclick="stage('log');"><a id="log-href" href="#log">Log</a></li>
            <li onclick="stage('about');" style="float:right"><a id="about-href" href="#about">About</a></li>
        </ul>

        <div id="status-stage" class="stage">
            <div>Current tag: <code id="current-tag">none</code></div>
            <div>Current track: <code id="current-track">-</code></div>
            <div>Total tracks: <code id="total-tracks">-</code></div>
            <div>Current Track Resource: <code id="current-track-res">-</code></div>
        </div>
        <div id="log-stage" class="stage log"></div>
        <div id="library-stage" class="stage"></div>
        <div id="about-stage" class="stage">
            <p>Tonio is the free juke-box software for children and beyond</p>
            <p>For more information, please reach the project web site at <a href="https://github.com/comick/tonio/">https://github.com/comick/tonio/</a>.</p>           
        </div>
    </body>
</html>
